## API Endpoint Implementation Plan: POST /api/dietitian/invitations\n\n### 1. Przegląd punktu końcowego\n\nPunkt końcowy tworzy zaproszenie dla nowego pacjenta (tylko rola dietetyka). Tworzy rekord w tabeli `invitations`, generuje unikalny token z datą wygaśnięcia i wysyła email z linkiem rejestracyjnym. Dodatkowo rejestruje wpis w audycie i event analityczny.\n\n- **Cel**: umożliwić dietetykowi zaproszenie pacjenta do aplikacji.\n- **Tabela DB**: `invitations` (id, email, token [unique], created_by, expires_at, used_at, created_at).\n- **Efekty uboczne**: wysyłka email, audit log, event analytics.\n- **Autoryzacja**: zalogowany użytkownik z rolą `dietitian`.\n\n### 2. Szczegóły żądania\n\n- **Metoda HTTP**: POST\n- **Struktura URL**: `/api/dietitian/invitations`\n- **Nagłówki**:\n  - `Content-Type: application/json`\n  - Cookie sesyjny Lucia (ustawiany przez middleware)\n- **Parametry**:\n  - **Wymagane**: brak w URL\n  - **Opcjonalne**: brak\n- **Request Body**:\n  - Typ: `CreateInvitationRequest`\n  - Struktura:\n\n    ```json\n    { \"email\": \"newpatient@example.com\" }\n    ```\n\n- **Walidacja wejścia (Zod)**:\n  - `email`: wymagany, poprawny email (RFC 5322), `trim()`, `toLowerCase()`\n\n### 3. Wykorzystywane typy\n\n- **DTOs** (z `src/types.ts`):\n  - `CreateInvitationRequest`\n  - `CreateInvitationResponse`\n- **Command Models** (z `src/types.ts`):\n  - `CreateInvitationCommand`\n  - `CreateAuditLogCommand`\n  - `CreateEventCommand`\n- **Encje DB** (z `src/db/schema.ts`):\n  - `users`, `invitations`, `auditLog`, `events`\n\n### 4. Szczegóły odpowiedzi\n\n- **Sukces (201 Created)**: `CreateInvitationResponse`\n\n  ```json\n  {\n    \"invitation\": {\n      \"id\": \"uuid\",\n      \"email\": \"newpatient@example.com\",\n      \"token\": \"invite_abc123...\",\n      \"expiresAt\": \"2025-10-31T12:00:00Z\",\n      \"createdBy\": \"dietitian_uuid\"\n    },\n    \"message\": \"Invitation email sent successfully\"\n  }\n  ```\n\n- **Kody statusu**:\n  - `201 Created` – utworzono zaproszenie i wysłano email\n  - `400 Bad Request` – nieprawidłowe dane wejściowe (np. email)\n  - `401 Unauthorized` – brak sesji\n  - `403 Forbidden` – rola inna niż `dietitian`\n  - `409 Conflict` – email ma już aktywne konto\n  - `500 Internal Server Error` – błąd serwera/SMTP\n\n### 5. Przepływ danych\n\n1. Middleware `auth` (Lucia) wypełnia `locals.user` i `locals.session`.\n2. Handler `POST` sprawdza:\n   - czy `locals.user` istnieje → w przeciwnym razie `401`;\n   - czy `locals.user.role === 'dietitian'` → w przeciwnym razie `403`.\n3. Parsuje `request.json()`, waliduje przez `createInvitationSchema` (Zod).\n4. Sprawdza w `users` czy `email` już istnieje (case-insensitive):\n   - jeśli tak → `409 Conflict`.\n5. Generuje bezpieczny `token` (np. `randomBytes(32).toString('hex')`) i `expiresAt = now + 7 dni`.\n6. Zapisuje rekord w `invitations` via `InvitationRepository.create(command)`.\n7. Buduje link rejestracyjny: `${APP_ORIGIN}/logowanie?invitation=${token}`\n   - Preferuj `APP_ORIGIN` z env (`PUBLIC_APP_URL`) lub `Astro.site`.\n8. Wysyła email `sendInvitationEmail()` z szablonu `src/emails/Invitation.tsx` (SMTP OVH):\n   - w dev loguje do konsoli (flaga `isDev`).\n9. Asynchronicznie:\n   - zapisuje `auditLogRepository.create({ action: 'create', tableName: 'invitations', ... })`;\n   - zapisuje `eventRepository.create({ eventType: 'invitation_created', ... })`.\n10. Zwraca `201 Created` z `CreateInvitationResponse`.\n\n### 6. Względy bezpieczeństwa\n\n- **Uwierzytelnienie**: Lucia v3; odczyt sesji z cookie via middleware.\n- **Autoryzacja (RBAC)**: wyłącznie użytkownicy z rolą `dietitian`.\n- **Token**: kryptograficznie losowy (`crypto.randomBytes(32)`), unikalny (`invitations.token` ma unique index), jednokrotnego użytku (przyszłe endpointy rejestracji oznaczą `used_at`).\n- **Ekspozycja informacji**: `409` ujawnia istnienie konta; endpoint jest dostępny tylko dla dietetyków po zalogowaniu, więc ryzyko akceptowalne na MVP.\n- **Email**: walidacja adresu, brak interpolacji niezweryfikowanych danych do HTML bez sanitizacji; szablon React Email.\n- **Rate limiting**: wyłączone w MVP (zgodnie z decyzją), można dodać później.\n- **Dane wrażliwe**: brak PII poza adresem email; brak logowania pełnych tokenów w produkcji.\n\n### 7. Obsługa błędów\n\n- `400 Bad Request` – walidacja Zod (nieprawidłowy format email), zwróć `ApiError`.\n- `401 Unauthorized` – brak sesji (`locals.user` null).\n- `403 Forbidden` – `locals.user.role !== 'dietitian'`.\n- `409 Conflict` – istnieje użytkownik o tym emailu (aktywny account).\n- `500 Internal Server Error` – nieoczekiwany błąd DB/SMTP:\n  - log do konsoli (MVP); rozważ event `invitation_email_failed`.\n- Powrót `Content-Type: application/json` i spójna struktura `ApiError`.\n\n### 8. Rozważania dotyczące wydajności\n\n- Operacje proste (1 select użytkownika, 1 insert, 1 wysyłka email). Brak wąskich gardeł.\n- Indeksy:\n  - `users.email` (unique) – już jest.\n  - `invitations.token` (unique) – już jest.\n- Wysyłka email synchroniczna w MVP (gwarancja powodzenia); w przyszłości można odseparować (kolejka) i zwracać 202.\n\n### 9. Kroki implementacji\n\n1. Schemat walidacji (Zod)\n   - Plik: `src/schemas/invitation.ts`\n   - Eksportuj `createInvitationSchema = z.object({ email: z.string().email().trim().toLowerCase() })`.\n\n2. Repository: `InvitationRepository`\n   - Plik: `src/lib/repositories/invitationRepository.ts`\n   - Metody:\n     - `findUserByEmail(email: string): Promise<User | null>`\n     - `create(command: CreateInvitationCommand): Promise<Invitation>`\n   - Wstaw do `invitations` wartości: `email`, `token`, `createdBy`, `expiresAt`.\n\n3. Service: `InvitationService`\n   - Plik: `src/lib/services/invitationService.ts`\n   - Publiczne API: `createInvitation({ email, createdBy }: { email: string; createdBy: string })`\n   - Logika:\n     - sprawdzenie istnienia użytkownika (409);\n     - generacja tokenu i `expiresAt` (+7 dni);\n     - zapis przez repository;\n     - asynchroniczny `auditLogRepository.create(...)` i `eventRepository.create(...)`;\n     - zwrot DTO do API.\n\n4. Email – szablon i wysyłka\n   - Szablon: `src/emails/Invitation.tsx` (React Email) – treść z CTA do rejestracji.\n   - Funkcja: w `src/lib/email.ts` dodać `sendInvitationEmail(to, inviteLink, createdByName?, smtpConfig, isDev)`.\n   - Korzystaj z istniejącej konfiguracji SMTP (OVH) i trybu dev (log instead of send).\n\n5. API Route\n   - Plik: `src/pages/api/dietitian/invitations.ts`\n   - `export const prerender = false`\n   - Handler `POST` (wzór jak w `src/pages/api/weight.ts`):\n     - auth (401) i rbac (403) z `locals.user`;\n     - walidacja Zod (400 – invalid input);\n     - delegacja do `invitationService.createInvitation(...)`;\n     - budowa linku `${APP_ORIGIN}/logowanie?invitation=${token}` i `sendInvitationEmail` (await);\n     - zwrot `201` z `CreateInvitationResponse`.\n\n6. Konfiguracja\n   - ENV: `PUBLIC_APP_URL` (np. `https://paulinamaciak.pl`), `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`.\n   - Brak zmian w `vercel.json` (to nie cron).\n\n7. Telemetria i audyt\n   - Audit: `action: 'create'`, `tableName: 'invitations'`, `recordId: invitation.id`, `after: { email, expiresAt }`.\n   - Event: `eventType: 'invitation_created'`, `properties: { method: 'dietitian_panel' }`.\n\n8. Testy (manual/E2E na MVP)\n   - Scenariusze:\n     - 201 – poprawny email; rekord w DB, email wysłany, audit/event zapisane.\n     - 400 – niepoprawny email.\n     - 401 – brak sesji.\n     - 403 – rola ≠ dietitian.\n     - 409 – email istniejącego użytkownika.\n     - 500 – symulacja błędu SMTP.\n\n### 10. Szkice interfejsów (orientacyjne)\n\n- `CreateInvitationCommand` (z `src/types.ts`):\n\n  ```ts\n  type CreateInvitationCommand = {\n    email: string\n    createdBy: string\n    expiresAt: Date\n  }\n  ```\n\n- Odpowiedź (DTO – z `src/types.ts`):\n\n  ```ts\n  type CreateInvitationResponse = {\n    invitation: {\n      id: string\n      email: string\n      token: string\n      expiresAt: Date\n      createdBy: string\n    }\n    message: string\n  }\n  ```\n\n### 11. Mapowanie błędów na statusy\n\n- Zod error → `400 Bad Request` (`error: 'validation_error'`).\n- Brak sesji → `401 Unauthorized`.\n- Rola inna niż dietetyk → `403 Forbidden`.\n- Istniejący użytkownik (email) → `409 Conflict`.\n- Inne (DB/SMTP) → `500 Internal Server Error`.\n\n### 12. Uwagi implementacyjne\n\n- Zachowaj spójny styl z istniejącymi endpointami (`weight.ts`, `auth/login.ts`).\n- Zwracaj `Content-Type: application/json` oraz `Cache-Control: no-store` (dane operacyjne, brak cache).\n- Nie loguj pełnych tokenów w produkcji; w dev ok.\n- Przygotuj przyszłe endpointy `GET /api/invitations/:token` oraz `POST /api/auth/signup` wykorzystujące `invitations.used_at`.\n*** End Patch

