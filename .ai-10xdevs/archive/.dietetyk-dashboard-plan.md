# Plan implementacji widoku Dietetyk Dashboard

## 1. PrzeglÄ…d

Widok â€Dietetyk Dashboardâ€ sÅ‚uÅ¼y do przeglÄ…du wszystkich pacjentÃ³w wraz z ich statusem oraz szybkim wglÄ…dem w speÅ‚nienie tygodniowego obowiÄ…zku dodania wagi. Dodatkowo udostÄ™pnia filtr po statusie pacjenta, paginacjÄ™ oraz podstawowy widget KPI (ile aktywnych pacjentÃ³w i ilu z wpisem w bieÅ¼Ä…cym tygodniu).

Zakres wdroÅ¼enia obejmuje:
- SSR strona pod Å›cieÅ¼kÄ… `/dietetyk/dashboard` z kontrolÄ… dostÄ™pu (rola: dietetyk).
- IntegracjÄ™ z endpointem `GET /api/dietitian/patients`.
- UI desktop (tabela) i mobile (karty) z paginacjÄ… i filtrami.
- Widget KPI z podstawowÄ… metrykÄ… (aktywni vs wpis tygodniowy).
- ObsÅ‚ugÄ™ stanÃ³w: Å‚adowanie, puste dane, bÅ‚Ä…d, brak uprawnieÅ„.

## 2. Routing widoku

- ÅšcieÅ¼ka: `/dietetyk/dashboard`
- DostÄ™p: tylko zalogowany uÅ¼ytkownik o roli `dietitian` (RBAC).
- Mechanizmy:
  - SSR (Astro, `output: 'server'`).
  - Middleware `auth` + `rbac` (juÅ¼ obecne w projekcie) â€“ wymusi sesjÄ™ i rolÄ™.
  - W razie `401` â†’ redirect do `/logowanie`. W razie `403` â†’ UI z komunikatem â€brak uprawnieÅ„â€.

## 3. Struktura komponentÃ³w

Drzewo (wysoki poziom):

- `src/pages/dietetyk/dashboard.astro`
  - `DietitianDashboardApp` (React)
    - `DashboardKPIWidget`
    - `PatientListFilters`
    - `PatientListContainer`
      - [desktop â‰¥ md] `PatientTable`
        - `PatientRow` (xN)
      - [mobile < md] `PatientCardList`
        - `PatientCard` (xN)
    - `PaginationControls`
    - Stany wspierajÄ…ce:
      - `LoadingSkeleton`
      - `EmptyState`
      - `ErrorAlert`
    - Drobne atomy:
      - `StatusBadge`
      - `WeeklyObligationBadge`

## 4. SzczegÃ³Å‚y komponentÃ³w

### DietitianDashboardApp
- Opis: Kontener logiki UI (React) â€“ zarzÄ…dza filtrem statusu, paginacjÄ…, pobieraniem danych i deleguje render do tabeli/kart. Prezentuje KPI, filtry, listÄ™ i paginacjÄ™.
- GÅ‚Ã³wne elementy:
  - Wrapper layoutu (sekcja nagÅ‚Ã³wkowa + sekcja listy).
  - WstrzykniÄ™te dane SSR (opcjonalnie: `initialData`) + client fetch dla zmian filtrÃ³w/strony.
- ObsÅ‚ugiwane interakcje:
  - Zmiana filtra statusu.
  - Zmiana strony (paginacja).
  - KlikniÄ™cie wiersza/karty â†’ przejÅ›cie do `/dietetyk/pacjenci/:id`.
- Walidacja:
  - Dopuszczalne statusy: `active | paused | ended | all`.
  - `limit` w [1, 100] (domyÅ›lnie 50), `offset` â‰¥ 0 (wyliczany z `page`).
  - NieuÅ¼ycie wartoÅ›ci spoza dozwolonego zakresu w zapytaniach.
- Typy:
  - WejÅ›ciowe DTO: `GetPatientsResponse`, `PatientListItemDTO`, `OffsetPagination`, `ApiError`.
  - ViewModel: `DashboardQueryVM`, `PaginationState`, `DashboardKPI`.
- Propsy:
  - `initialQuery?: DashboardQueryVM`
  - `initialData?: GetPatientsResponse`

### DashboardKPIWidget
- Opis: WyÅ›wietla metrykÄ™ â€aktywni pacjenci | ilu z wpisem (procent)â€. Liczone po obecnie zaÅ‚adowanej liÅ›cie lub (opcjonalnie) rozszerzone w przyszÅ‚oÅ›ci o dedykowany endpoint KPI.
- GÅ‚Ã³wne elementy:
  - Teksty liczbowe z wyrÃ³Å¼nieniem procentu.
  - Opcjonalne ikonki statusu.
- Interakcje: brak (display-only).
- Walidacja: brak (operuje na juÅ¼ zweryfikowanych danych listy).
- Typy:
  - `DashboardKPI` (aktywni, z wpisem, rate).
- Propsy:
  - `data: GetPatientsResponse` lub `kpi: DashboardKPI`

### PatientListFilters
- Opis: Kontrolki filtru po statusie (dropdown) i (post-MVP) pole wyszukiwania.
- GÅ‚Ã³wne elementy:
  - `select` z wartoÅ›ciami: â€Wszyscyâ€, â€Aktywniâ€, â€Wstrzymaniâ€, â€ZakoÅ„czeniâ€.
- Interakcje:
  - `onChange(status)` â†’ aktualizacja URL query + refetch danych.
- Walidacja:
  - Status tylko z dozwolonego zbioru.
- Typy:
  - `PatientStatusFilter = 'all' | 'active' | 'paused' | 'ended'`
- Propsy:
  - `value: PatientStatusFilter`
  - `onChange: (value: PatientStatusFilter) => void`

### PatientTable (desktop)
- Opis: Tabela listy pacjentÃ³w dla ekranÃ³w â‰¥ md.
- GÅ‚Ã³wne elementy:
  - Kolumny: ImiÄ™ i nazwisko, Status, Ostatni wpis (data), ObowiÄ…zek tygodniowy (tak/nie).
  - ARIA: `role="table"`, podpis.
- Interakcje:
  - Klik w wiersz â†’ przejÅ›cie do szczegÃ³Å‚Ã³w pacjenta.
  - Fokus/klawiatura: Tab przez wiersze, Enter otwiera szczegÃ³Å‚y.
- Walidacja: brak â€“ tylko prezentacja otrzymanych danych.
- Typy:
  - `PatientListItemVM[]` (z polami pomocniczymi, np. `fullName`).
- Propsy:
  - `items: PatientListItemVM[]`
  - `onRowClick: (patientId: string) => void`

### PatientCardList (mobile)
- The same data as table, w layoucie kartowym z badgeâ€™ami.
- Interakcje:
  - Tap w kartÄ™ â†’ przejÅ›cie do szczegÃ³Å‚Ã³w pacjenta.
- Typy/propsy identyczne jak w tabeli, ale renderowane w `PatientCard`.

### PatientRow / PatientCard
- Opis: Jednostkowa prezentacja pacjenta.
- GÅ‚Ã³wne elementy:
  - `StatusBadge` (ğŸŸ¢, ğŸŸ¡, ğŸ”´), `WeeklyObligationBadge` (ğŸŸ¢/ğŸ”´), data ostatniego wpisu.
- Interakcje:
  - Klik/tap â†’ przejÅ›cie do `/dietetyk/pacjenci/:id`.
- Walidacja: brak.
- Propsy:
  - `item: PatientListItemVM`
  - `onClick: () => void`

### PaginationControls
- Opis: Nawigacja po stronach, â€Poprzednia/NastÄ™pnaâ€ + numeracja.
- GÅ‚Ã³wne elementy:
  - Przyciski z disabled przy braku dalszych stron.
- Interakcje:
  - `onPageChange(page: number)` â†’ aktualizacja URL + refetch.
- Walidacja:
  - `page >= 1`, `offset = (page - 1) * limit`.
- Typy:
  - `PaginationState`
- Propsy:
  - `pagination: PaginationState`
  - `onPageChange: (page: number) => void`

### LoadingSkeleton / EmptyState / ErrorAlert
- Opis: Stany pomocnicze.
- Interakcje: brak.
- Walidacja: brak.
- Propsy:
  - `ErrorAlert`: `message: string`

### StatusBadge / WeeklyObligationBadge
- Opis: Drobne atomy prezentujÄ…ce status oraz speÅ‚nienie obowiÄ…zku tygodniowego.
- Propsy:
  - `StatusBadge`: `status: 'active' | 'paused' | 'ended' | null`
  - `WeeklyObligationBadge`: `met: boolean`

## 5. Typy

Wykorzystanie istniejÄ…cych DTO z `src/types.ts`:
- `GetPatientsResponse`: `{ patients: PatientListItemDTO[], pagination: OffsetPagination }`
- `PatientListItemDTO`: `id, firstName, lastName, email, age, gender, status, createdAt, lastWeightEntry, weeklyObligationMet`
- `OffsetPagination`: `total, limit, offset, hasMore`
- `ApiError`

Nowe typy ViewModel (lokalne dla widoku):

```ts
// Filtry i zapytanie w UI
export type PatientStatusFilter = 'all' | 'active' | 'paused' | 'ended'

export type DashboardQueryVM = {
  status: PatientStatusFilter
  page: number            // 1-based
  limit: number           // default 50, 1..100
}

// Stan paginacji w UI
export type PaginationState = {
  page: number
  pageSize: number
  total: number
  hasMore: boolean
}

// Dane do KPI (obliczane z listy lub z osobnego endpointu w przyszÅ‚oÅ›ci)
export type DashboardKPI = {
  activePatients: number
  withEntryThisWeek: number
  rate: number            // 0..100
}

// VM listy pacjentÃ³w (wzbogacenie DTO o pola prezentacyjne)
export type PatientListItemVM = {
  id: string
  fullName: string
  status: 'active' | 'paused' | 'ended' | null
  lastWeightEntry: Date | null
  weeklyObligationMet: boolean
  // opcjonalnie dodatkowe pola sformatowane:
  lastWeightEntryText: string
}
```

Konwersje:
- `PatientListItemDTO` â†’ `PatientListItemVM` (zÅ‚oÅ¼enie `firstName` + `lastName` â†’ `fullName`, sformatowanie daty).
- `OffsetPagination` â†’ `PaginationState` (mapowanie `offset, limit, total, hasMore` na `page, pageSize, total, hasMore`).

## 6. ZarzÄ…dzanie stanem

- Å¹rÃ³dÅ‚o prawdy: URL query (`status`, `page`) + dane z API.
- SSR:
  - `dashboard.astro` moÅ¼e pobraÄ‡ `initialData` (pierwsze renderowanie) i wstrzyknÄ…Ä‡ do React.
  - Client-side: na zmianÄ™ filtra/strony â€“ refetch do `/api/dietitian/patients`.
- Proponowany hook: `useDietitianPatients(query: DashboardQueryVM)`
  - Stan: `data`, `isLoading`, `error`, `pagination`.
  - Efekt: refetch po zmianie `query`.
  - Aktualizacja URL przez `history.replaceState` lub `URLSearchParams` (bez reloadu).
- Dane KPI:
  - W MVP wyliczane na podstawie bieÅ¼Ä…cej strony: `activePatients = patients.length` dla statusu `active` (lub policzyÄ‡ po filtrze), `withEntryThisWeek` = liczba `weeklyObligationMet === true`.
  - W przyszÅ‚oÅ›ci: dedykowany endpoint KPI (po caÅ‚ej bazie).

## 7. Integracja API

- Endpoint: `GET /api/dietitian/patients?status={filter}&limit={limit}&offset={offset}`
  - Parametry:
    - `status`: `active | paused | ended | all` (domyÅ›lnie `active`)
    - `limit`: 1â€“100 (domyÅ›lnie 50)
    - `offset`: â‰¥0 (domyÅ›lnie 0)
  - OdpowiedÅº 200: `GetPatientsResponse`
  - BÅ‚Ä™dy:
    - `401 unauthorized`
    - `403 forbidden`
    - `400 validation_error`
    - `500 internal_server_error`
- Mapowanie requestu:
  - `offset = (page - 1) * limit`
- Mapowanie response:
  - `patients: PatientListItemDTO[]` â†’ `PatientListItemVM[]`
  - `pagination: OffsetPagination` â†’ `PaginationState`

## 8. Interakcje uÅ¼ytkownika

- Zmiana filtra statusu:
  - Aktualizacja `status` w URL (`?status=active|paused|ended|all`), reset strony do 1.
  - Refetch danych, odÅ›wieÅ¼enie listy i KPI.
- Zmiana strony:
  - Aktualizacja `page` w URL, refetch z nowym `offset`.
- KlikniÄ™cie pacjenta (wiersz/karta):
  - PrzejÅ›cie do `/dietetyk/pacjenci/:id`.
- DostÄ™pnoÅ›Ä‡:
  - Klawiatura: Tab przez wiersze/karty, Enter otwarcie szczegÃ³Å‚u.
  - ARIA: labelki dla tabeli i filtrÃ³w, kontrast badgeâ€™Ã³w.

## 9. Warunki i walidacja

- UI:
  - `status` ograniczony do predefiniowanych wartoÅ›ci (select).
  - `limit` ustawione na 50, nieedytowalne w UI w MVP (zgodnie z planem).
  - `page >= 1`; przy niepoprawnej wartoÅ›ci w URL â€“ fallback do 1.
- API:
  - Dopuszczalne `status/limit/offset` â€“ UI generuje wyÅ‚Ä…cznie poprawne wartoÅ›ci.
  - Reakcje na bÅ‚Ä™dy walidacji:
    - `400`: reset filtra i strony do domyÅ›lnych oraz komunikat o przywrÃ³ceniu domyÅ›lnych ustawieÅ„.

## 10. ObsÅ‚uga bÅ‚Ä™dÃ³w

- `401 unauthorized`:
  - SSR: redirect do `/logowanie`.
  - Client: pokazanie CTA do ponownego logowania (fallback).
- `403 forbidden`:
  - UI: komunikat â€Tylko dietetycy majÄ… dostÄ™p do tego widokuâ€.
- `400 validation_error`:
  - UI: bezpieczny fallback â€“ ustawienia domyÅ›lne (status=active, page=1) + toast.
- `500 internal_server_error`:
  - UI: `ErrorAlert` + przycisk â€SprÃ³buj ponownieâ€.
- Brak danych:
  - `EmptyState` z sugestiÄ… â€ZaproÅ› pierwszego pacjentaâ€.

## 11. Kroki implementacji

1) Routing i SSR:
   - UtwÃ³rz `src/pages/dietetyk/dashboard.astro`:
     - SprawdÅº `Astro.locals.user` (middleware), w razie braku â€“ redirect do `/logowanie`.
     - W razie roli â‰  `dietitian` â€“ renderuj stronÄ™ z komunikatem 403 (lub redirect do `/`).
     - Odczytaj `status` i `page` z query; zastosuj domyÅ›lne (`active`, `1`) i walidacjÄ™.
     - Pobierz `initialData` z `GET /api/dietitian/patients` (SSR) i przekaÅ¼ do React.

2) Kontener React:
   - UtwÃ³rz `src/components/waga/dietitian/DietitianDashboardApp.tsx`:
     - Propsy: `initialQuery?`, `initialData?`.
     - Stan: `query`, `data`, `isLoading`, `error`, `pagination`.
     - Hook `useDietitianPatients` do refetch na zmianÄ™ `query`.
     - Layout: `DashboardKPIWidget`, `PatientListFilters`, `PatientListContainer`, `PaginationControls`, `ErrorAlert`, `LoadingSkeleton`, `EmptyState`.

3) Hook danych:
   - UtwÃ³rz `src/hooks/useDietitianPatients.ts`:
     - API call do `/api/dietitian/patients` (fetch, `credentials: 'include'`).
     - Mapowanie DTO â†’ VM + budowa `PaginationState`.
     - Ekspozycja: `{ data, isLoading, error, pagination, refetch }`.

4) Komponenty UI:
   - `DashboardKPIWidget.tsx`
   - `PatientListFilters.tsx`
   - `PatientTable.tsx`, `PatientRow.tsx`
   - `PatientCardList.tsx`, `PatientCard.tsx`
   - `PaginationControls.tsx`
   - Atomy: `StatusBadge.tsx`, `WeeklyObligationBadge.tsx`, `ErrorAlert.tsx`, `LoadingSkeleton.tsx`, `EmptyState.tsx`
   - Stylowanie: Tailwind (spÃ³jne z projektem), responsywnoÅ›Ä‡ (breakpoint `md`).

5) Typy:
   - Zdefiniuj nowe VM typy lokalnie w folderze komponentÃ³w (`types.ts`) lub wspÃ³Å‚dzielone w `src/types.ts` (jeÅ›li bÄ™dÄ… uÅ¼ywane szerzej).
   - UÅ¼ywaj istniejÄ…cych DTO z `src/types.ts` dla interfejsu API.

6) ObsÅ‚uga URL i nawigacji:
   - Synchronizacja `status/page` â†” URL (push/replaceState) + odczyt przy mountâ€™cie.
   - Upewnij siÄ™, Å¼e zmiana filtra resetuje `page` do 1.

7) A11y i UX:
   - ARIA atrybuty dla tabeli i filtrÃ³w.
   - Focus states i kontrast badgeâ€™Ã³w.
   - Skeleton dla czasu Å‚adowania.

8) Testy rÄ™czne:
   - Scenariusze: brak sesji (401), zÅ‚a rola (403), brak pacjentÃ³w (empty), success (dane), bÅ‚Ä…d 500.
   - SprawdziÄ‡ dziaÅ‚anie paginacji i filtra.

9) (Opcjonalnie) Telemetria:
   - Eventy UI: `view_dietitian_dashboard`, `filter_change`, `page_change`, `patient_row_click`.
   - WysyÅ‚ka przez istniejÄ…cy mechanizm (po dodaniu do MVP).

â€” Koniec â€” 


