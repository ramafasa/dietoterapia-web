---
/**
 * PZK Reviews Page - /pacjent/pzk/recenzje
 *
 * This page displays:
 * - List of all PZK reviews from other patients (social proof)
 * - Panel to add/edit/delete user's own review (max 1 per patient)
 *
 * Access control:
 * - Requires authenticated patient with active PZK access
 * - Redirects unauthenticated → /logowanie
 * - Redirects dietitian → 403
 * - Redirects no access → /pzk/kup
 *
 * Implementation: SSR-first with React island for interactivity
 */

import { isFeatureEnabled } from '@/lib/feature-flags'

// Feature flag: Return 404 if PZK is disabled
if (!isFeatureEnabled('PZK')) {
  return new Response(null, { status: 404, statusText: 'Not Found' })
}

import Layout from '@/layouts/Layout.astro'
import { db } from '@/db'
import { PzkAccessService } from '@/lib/services/pzkAccessService'
import { PzkReviewsPage } from '@/components/pzk/reviews/PzkReviewsPage'

const user = Astro.locals.user

// ============================================================================
// 1. Unauthenticated user → redirect to login
// ============================================================================
if (!user) {
  return Astro.redirect('/logowanie', 302)
}

// ============================================================================
// 2. Dietitian → 403 Forbidden
// ============================================================================
if (user.role === 'dietitian') {
  Astro.response.status = 403
  // Render 403 page below
}

// ============================================================================
// 3. Patient → check access
// ============================================================================
let shouldRenderForbidden = false
let shouldRenderError = false

if (user.role === 'patient') {
  try {
    const pzkAccessService = new PzkAccessService(db)
    const summary = await pzkAccessService.getAccessSummary(user.id)

    // No active access → redirect to purchase landing
    if (!summary.hasAnyActiveAccess) {
      return Astro.redirect('/pzk/kup', 302)
    }

    // User has access → continue to render reviews
  } catch (error) {
    // Server error → show error page with retry
    console.error('[/pacjent/pzk/recenzje] Error fetching access summary:', error)
    Astro.response.status = 500
    shouldRenderError = true
  }
} else {
  // Unknown role → 403
  Astro.response.status = 403
  shouldRenderForbidden = true
}

// ============================================================================
// Render error/forbidden pages or main reviews view
// ============================================================================
const is403 = Astro.response.status === 403
const is500 = Astro.response.status === 500
---

<Layout
  title="Recenzje - Przestrzeń Zdrowej Kobiety | Paulina Maciak Dietetyka Kliniczna"
  description="Zobacz opinie innych uczestniczek Przestrzeni Zdrowej Kobiety i podziel się swoją recenzją."
>
  {is403 && (
    <main class="min-h-screen flex items-center justify-center bg-neutral-light px-4 py-12">
      <div class="max-w-md w-full text-center">
        <h1 class="text-4xl font-heading font-bold text-neutral-dark mb-4">
          Brak dostępu
        </h1>
        <p class="text-lg text-neutral-dark/80 mb-8">
          Ta strona jest dostępna tylko dla pacjentów z aktywnym dostępem do Przestrzeni Zdrowej Kobiety.
        </p>
        <div class="flex flex-col gap-4">
          <a
            href="/pzk/kup"
            class="inline-block px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primary/90 transition-colors"
          >
            Dowiedz się więcej o PZK
          </a>
          <a
            href="/"
            class="inline-block px-6 py-3 border-2 border-primary text-primary rounded-lg font-semibold hover:bg-primary/5 transition-colors"
          >
            Wróć na stronę główną
          </a>
        </div>
      </div>
    </main>
  )}

  {is500 && (
    <main class="min-h-screen flex items-center justify-center bg-neutral-light px-4 py-12">
      <div class="max-w-md w-full text-center">
        <h1 class="text-4xl font-heading font-bold text-neutral-dark mb-4">
          Wystąpił błąd
        </h1>
        <p class="text-lg text-neutral-dark/80 mb-8">
          Nie udało się załadować recenzji. Spróbuj ponownie za chwilę.
        </p>
        <div class="flex flex-col gap-4">
          <button
            onclick="window.location.reload()"
            class="inline-block px-6 py-3 bg-primary text-white rounded-lg font-semibold hover:bg-primary/90 transition-colors"
          >
            Spróbuj ponownie
          </button>
          <a
            href="/pacjent/pzk"
            class="inline-block px-6 py-3 border-2 border-primary text-primary rounded-lg font-semibold hover:bg-primary/5 transition-colors"
          >
            Wróć do PZK
          </a>
        </div>
      </div>
    </main>
  )}

  {!is403 && !is500 && (
    <!-- Main reviews view - React island -->
    <PzkReviewsPage client:load />
  )}
</Layout>
