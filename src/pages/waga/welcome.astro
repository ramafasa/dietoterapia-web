---
import Layout from '@/layouts/Layout.astro';
import WelcomeHero from '@/components/waga/WelcomeHero';
import OnboardingSteps from '@/components/waga/OnboardingSteps';
import WeightEntryWidget from '@/components/waga/WeightEntryWidget';
import { hasWeightEntries } from '@/lib/weight';

const user = Astro.locals.user;

// Auth middleware already handles user check and role verification
// If user is null or not 'patient', RBAC middleware will redirect
if (!user) {
  return Astro.redirect('/logowanie');
}

if (user.role !== 'patient') {
  return Astro.redirect('/dietetyk/pacjenci');
}

// Check if user already has weight entries - if yes, redirect to dashboard
const userHasEntries = await hasWeightEntries(user.id);

if (userHasEntries) {
  return Astro.redirect('/waga');
}

const firstName = user.firstName || 'Pacjencie';
---

<Layout title="Witaj w Monitoringu Wagi - Paulina Maciak Dietetyka Kliniczna">
  <main class="min-h-screen bg-neutral-light py-12">
    <div class="container mx-auto px-4">
      <!-- Welcome Hero Section -->
      <WelcomeHero firstName={firstName} client:load />

      <!-- Onboarding Steps -->
      <OnboardingSteps client:visible />

      <!-- Weight Entry Form Widget -->
      <WeightEntryWidget client:load />
    </div>
  </main>
</Layout>
