---
// Google Analytics 4 - loads conditionally based on cookie consent
const measurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
---

{measurementId && (
  <script is:inline define:vars={{ measurementId }}>
    // Check cookie consent before loading GA
    function getCookieConsent() {
      const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('cookieConsent='))
        ?.split('=')[1];

      if (!cookieValue) return null;

      try {
        return JSON.parse(decodeURIComponent(cookieValue));
      } catch (e) {
        return null;
      }
    }

    // Load GA only if analytics consent is given
    const consent = getCookieConsent();
    if (consent && consent.analytics) {
      // Load gtag.js script
      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${measurementId}`;
      document.head.appendChild(script);

      // Initialize gtag
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        window.dataLayer.push(arguments);
      }
      gtag('js', new Date());
      gtag('config', measurementId, {
        anonymize_ip: true, // GDPR compliance - anonymize IP
        cookie_flags: 'SameSite=Lax;Secure', // Cookie security
      });

      // Make gtag available globally
      window.gtag = gtag;
    }
  </script>
)}
